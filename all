from azure.storage.blob import ContainerClient
import os

def download_blobs_from_directory(
    account_url: str,
    container_name: str,
    sas_token: str,
    directory_prefix: str,
    local_download_path: str
) -> list[str]:
    """
    Download all blobs from a virtual directory in Azure Blob Storage using a SAS token.
    
    Args:
        account_url: The Azure storage account URL (e.g., "https://<account_name>.blob.core.windows.net")
        container_name: Name of the container
        sas_token: The SAS token (with or without leading '?')
        directory_prefix: The virtual directory path (e.g., "folder1/subfolder/")
        local_download_path: Local directory to save downloaded files
    
    Returns:
        List of downloaded file paths
    """
    # Ensure SAS token starts with '?'
    if not sas_token.startswith('?'):
        sas_token = '?' + sas_token
    
    # Create the container client with SAS token
    container_url = f"{account_url}/{container_name}{sas_token}"
    container_client = ContainerClient.from_container_url(container_url)
    
    # Ensure directory prefix ends with '/'
    if directory_prefix and not directory_prefix.endswith('/'):
        directory_prefix += '/'
    
    # Create local download directory if it doesn't exist
    os.makedirs(local_download_path, exist_ok=True)
    
    downloaded_files = []
    
    # List and download all blobs with the specified prefix
    blobs = container_client.list_blobs(name_starts_with=directory_prefix)
    
    for blob in blobs:
        # Skip if it's just the directory marker
        if blob.name.endswith('/'):
            continue
        
        # Calculate relative path and local file path
        relative_path = blob.name[len(directory_prefix):] if directory_prefix else blob.name
        local_file_path = os.path.join(local_download_path, relative_path)
        
        # Create subdirectories if needed
        local_dir = os.path.dirname(local_file_path)
        if local_dir:
            os.makedirs(local_dir, exist_ok=True)
        
        # Download the blob
        blob_client = container_client.get_blob_client(blob.name)
        
        with open(local_file_path, 'wb') as file:
            download_stream = blob_client.download_blob()
            file.write(download_stream.readall())
        
        downloaded_files.append(local_file_path)
        print(f"Downloaded: {blob.name} -> {local_file_path}")
    
    return downloaded_files


def list_blobs_in_directory(
    account_url: str,
    container_name: str,
    sas_token: str,
    directory_prefix: str = ""
) -> list[dict]:
    """
    List all blobs in a virtual directory without downloading.
    
    Returns:
        List of dictionaries containing blob metadata
    """
    if not sas_token.startswith('?'):
        sas_token = '?' + sas_token
    
    container_url = f"{account_url}/{container_name}{sas_token}"
    container_client = ContainerClient.from_container_url(container_url)
    
    if directory_prefix and not directory_prefix.endswith('/'):
        directory_prefix += '/'
    
    blob_list = []
    blobs = container_client.list_blobs(name_starts_with=directory_prefix)
    
    for blob in blobs:
        if not blob.name.endswith('/'):
            blob_list.append({
                'name': blob.name,
                'size': blob.size,
                'last_modified': blob.last_modified,
                'content_type': blob.content_settings.content_type if blob.content_settings else None
            })
    
    return blob_list


# Example usage
if __name__ == "__main__":
    # Configuration - replace with your values
    ACCOUNT_URL = "https://yourstorageaccount.blob.core.windows.net"
    CONTAINER_NAME = "your-container"
    SAS_TOKEN = "sv=2022-11-02&ss=b&srt=co&sp=rl&se=2025-12-31T23:59:59Z&st=2025-01-01T00:00:00Z&spr=https&sig=your_signature_here"
    DIRECTORY_PREFIX = "data/input/"  # Virtual directory path
    LOCAL_PATH = "./downloaded_data"
    
    # List blobs first
    print("Listing blobs in directory...")
    blobs = list_blobs_in_directory(
        account_url=ACCOUNT_URL,
        container_name=CONTAINER_NAME,
        sas_token=SAS_TOKEN,
        directory_prefix=DIRECTORY_PREFIX
    )
    
    for blob in blobs:
        print(f"  {blob['name']} ({blob['size']} bytes)")
    
    print(f"\nFound {len(blobs)} blobs")
    
    # Download all blobs
    print("\nDownloading blobs...")
    downloaded = download_blobs_from_directory(
        account_url=ACCOUNT_URL,
        container_name=CONTAINER_NAME,
        sas_token=SAS_TOKEN,
        directory_prefix=DIRECTORY_PREFIX,
        local_download_path=LOCAL_PATH
    )
    
    print(f"\nDownloaded {len(downloaded)} files")
