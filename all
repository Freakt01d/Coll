import oracledb
import os
from glob import glob

def execute_all_sql_files(directory_path, connection_config):
    """
    Execute INSERT statements from all .sql files in a directory.
    """
    
    # Find all .sql files
    sql_files = glob(os.path.join(directory_path, '*.sql'))
    
    if not sql_files:
        print(f"No .sql files found in {directory_path}")
        return
    
    print(f"Found {len(sql_files)} .sql files")
    
    # Connect once for all files
    connection = oracledb.connect(
        user=connection_config['user'],
        password=connection_config['password'],
        dsn=connection_config['dsn']
    )
    cursor = connection.cursor()
    
    total_success = 0
    total_errors = 0
    
    try:
        for sql_file in sql_files:
            print(f"\nProcessing: {os.path.basename(sql_file)}")
            
            with open(sql_file, 'r') as f:
                sql_content = f.read()
            
            statements = [s.strip() for s in sql_content.split(';') if s.strip() and s.strip().upper().startswith('INSERT')]
            
            file_success = 0
            for stmt in statements:
                try:
                    cursor.execute(stmt)
                    file_success += 1
                except oracledb.Error as e:
                    total_errors += 1
                    print(f"  Error: {e}")
            
            connection.commit()
            total_success += file_success
            print(f"  Completed: {file_success} inserts")
        
        print(f"\n--- TOTAL: {total_success} successful, {total_errors} errors ---")
        
    finally:
        cursor.close()
        connection.close()


if __name__ == "__main__":
    
    config = {
        'user': 'ADMIN',
        'password': 'YourPassword123',
        'dsn': 'myhost.oraclecloud.com:1521/myservice_high'
    }
    
    sql_directory = '/home/vishal/sql_files/'  # Directory containing .sql files
    
    execute_all_sql_files(sql_directory, config)
