"""
Drop staging tables in a range
"""

import sys
import oracledb

# Database connection details
SCHEMA = "placeholder"
DB_USER = SCHEMA
DB_PASSWORD = "placeholder"
DB_HOST = "placeholder"
DB_PORT = "placeholder"
DB_SID = "placeholder"

ORACLE_CLIENT_PATH = r"D:\Homeware\instantclient_23_0"

def init_oracle_client():
    try:
        oracledb.init_oracle_client(lib_dir=ORACLE_CLIENT_PATH)
        print("Oracle thick mode initialized")
    except oracledb.ProgrammingError:
        pass

def get_connection():
    dsn = oracledb.makedsn(DB_HOST, DB_PORT, sid=DB_SID)
    return oracledb.connect(f"{DB_USER}/{DB_PASSWORD}@{dsn}")

def drop_staging_tables(table_prefix, start_idx, end_idx):
    """Drop staging tables from start_idx to end_idx (inclusive)"""
    
    conn = get_connection()
    cursor = conn.cursor()
    
    dropped = 0
    
    for i in range(start_idx, end_idx + 1):
        stg_name = f"{table_prefix}_STG{i:02d}"  # _STG00, _STG01, etc.
        try:
            cursor.execute(f"DROP TABLE {SCHEMA}.{stg_name} PURGE")
            dropped += 1
            if dropped % 20 == 0:
                print(f"  Dropped {dropped} tables...")
        except Exception as e:
            print(f"  {stg_name}: {e}")
    
    cursor.close()
    conn.close()
    
    print(f"\nDropped {dropped} tables")

def main():
    print("="*60)
    print("DROP STAGING TABLES IN RANGE")
    print("="*60)
    
    init_oracle_client()
    
    table_prefix = input("\nTable prefix (e.g., EDS_IDX_COMP_ITEM): ").strip().upper()
    start_idx = int(input("Start index (e.g., 0): ").strip())
    end_idx = int(input("End index (e.g., 147): ").strip())
    
    print(f"\nWill drop staging tables {table_prefix}_STG{start_idx} to {table_prefix}_STG{end_idx}")
    confirm = input("Continue? (y/n): ").strip().lower()
    
    if confirm != 'y':
        print("Cancelled.")
        return
    
    drop_staging_tables(table_prefix, start_idx, end_idx)

if __name__ == "__main__":
    main()
